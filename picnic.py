"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    Profile Photo Repeater                      â•‘
â•‘                    Developer: @xdesai                          â•‘
â•‘                    Optimized: @kramiikk                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ğ­Ñ‚Ğ¾Ñ‚ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑ‚ÑŒ Ñ„Ğ¾Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ
ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚.

ğŸ“ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:
    â€¢ .pfp <Ğ¿ÑƒÑ‚ÑŒ> - Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ
    â€¢ .pfpstop - ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ

ğŸ’¡ Ğ¡Ğ¾Ğ²ĞµÑ‚: Ğ’Ñ‹ Ñ‚Ğ°ĞºĞ¶Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ½Ğ° Ñ„Ğ¾Ñ‚Ğ¾ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹ .pfp, 
    Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ĞµĞ³Ğ¾ ĞºĞ°Ğº Ñ„Ğ¾Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ

âš ï¸ ĞÑ‚ĞºĞ°Ğ· Ğ¾Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸:
    Ğ Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ½Ğµ Ğ½ĞµÑĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ·Ğ° Ğ»ÑĞ±Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹,
    ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ½ÑƒÑ‚ÑŒ Ñ Ğ²Ğ°ÑˆĞ¸Ğ¼ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ¼.
"""

import asyncio
from telethon import functions
from .. import loader

@loader.tds
class PfpRepeaterMod(loader.Module):
    """Profile Photo Repeater Module"""
    strings = {"name": "PfpRepeater"}

    def __init__(self):
        self.config = loader.ModuleConfig(
            "DELAY",
            900,
            validator=loader.validators.Integer(),
        )
        self.running = False
        self.task = None

    async def client_ready(self, client, db):
        self.client = client

    async def set_profile_photo(self, photo_path):
        while self.running:
            file = await self.client.upload_file(photo_path)
            await self.client(functions.photos.UploadProfilePhotoRequest(file=file))
            await asyncio.sleep(self.config["DELAY"])

    async def _get_photo_path(self, message):
        reply = await message.get_reply_message()
        if reply and reply.photo:
            return await message.client.download_media(reply.photo)
        elif message.media and message.photo:
            return await message.client.download_media(message)
        return None

    @loader.command()
    async def pfp(self, message):
        """Start repeating profile photo every 15 minutes"""
        photo_path = await self._get_photo_path(message)
        if not photo_path:
            await message.edit("Please provide the photo or reply to a photo.")
            return

        if not self.running:
            self.running = True
            self.task = asyncio.create_task(self.set_profile_photo(photo_path))
            await message.edit(f"Started repeating profile photo every {self.config['DELAY']} seconds.")
        else:
            await message.edit("Profile photo repeater is already running.")

    @loader.command()
    async def pfpstop(self, message):
        """Stop repeating profile photo"""
        if self.running:
            self.running = False
            if self.task:
                self.task.cancel()
            await message.edit("Stopped repeating profile photo.")
        else:
            await message.edit("Profile photo repeater is not running.")
